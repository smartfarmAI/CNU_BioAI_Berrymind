services:
  fsm:
    build: ./statemachine         # FastAPI 서버 Dockerfile 위치
    container_name: fsm
    environment:
      - TZ=Asia/Seoul
    ports:
      - "9000:9000"
    healthcheck:
      # wget/curl 없이 Python 표준 라이브러리로 체크
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; r=urllib.request.urlopen('http://localhost:9000/health', timeout=2); sys.exit(0 if r.status==200 else 1)\""]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - timescale_db_default

  scheduler:
    build: ./scheduler_component         # FastAPI 서버 Dockerfile 위치
    container_name: scheduler
    environment:
      - TZ=Asia/Seoul
    ports:
      - "8001:8001"
    depends_on:
      fsm:
        condition: service_healthy
    healthcheck:
      # wget/curl 없이 Python 표준 라이브러리로 체크
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; r=urllib.request.urlopen('http://localhost:8001/health', timeout=2); sys.exit(0 if r.status==200 else 1)\""]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - timescale_db_default

  rule_engine:
    build: ./rule_engine              # 룰엔진 Dockerfile 위치
    container_name: rule_engine
    environment:
      - TZ=Asia/Seoul
      - DATABASE_URL=postgresql+psycopg://admin:admin123@tsdb:5432/berrymind  # DB 호스트명 확인(예: tsdb)
      - SUBMIT_BASE_URL=http://scheduler:8001/submit_schedules
    depends_on:
      scheduler:
        condition: service_healthy
    command: ["python", "rules_runner.py"]   # 1분마다 도는 APScheduler 엔트리포인트
    restart: unless-stopped
    networks:
      - timescale_db_default

networks:
  timescale_db_default:
    external: true
