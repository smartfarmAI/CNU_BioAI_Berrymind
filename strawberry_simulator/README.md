# 🍓 딸기 환경 제어 실시간 시뮬레이터 v2.0

**JavaScript 원본 제어 로직 완전 포팅 버전**

스마트팜 딸기 재배를 위한 환경 제어 시뮬레이터입니다. 기존 JavaScript 버전의 모든 제어 로직을 완벽하게 Python/Streamlit으로 포팅했습니다. 실시간으로 환경 센서 데이터를 기반으로 8개 장치의 정확한 동작을 시뮬레이션하고 모니터링할 수 있습니다.

## 🔄 JavaScript → Python 완전 포팅

기존 `controller_2.js`의 모든 제어 로직을 100% 동일하게 구현:
- ✅ FOG 분무 제어 (구간별 온도/시간 사이클)
- ✅ FCU 팬코일 제어 (히스테리시스 로직)
- ✅ CO₂ 공급 제어 (환경 조건별 보정)
- ✅ 보온커튼 제어 (외기온 고려)
- ✅ 차광스크린 제어 (비 감지 + 일사량)
- ✅ 관수시스템 제어 (토양수분 + 구간별)
- ✅ 유동팬 제어 (온도차 감지 사이클)
- ✅ 좌우천창 제어 (상태 머신 패턴)

## 주요 기능

### 🎛️ 정밀한 환경 제어 시스템

**1. FOG 분무 시스템**
- 구간별 온도 임계값: 구간 1,4(28℃), 구간 2,3(26℃)
- 동작/대기 사이클: 1분 동작 → 10분/30분 대기
- 비 감지 시 자동 중지

**2. FCU 팬코일 시스템**
- 구간 2: 30℃ ON → 27℃ OFF
- 구간 3: 28℃ ON → 25℃ OFF
- 히스테리시스 제어로 온/오프 반복 방지

**3. CO₂ 공급 시스템**
- 구간별 trigger/target 농도 자동 조절
- 환경 조건 보정: 일사량↓(×0.8), 비(×0.6), 습도↑(×0.7)

**4. 좌우천창 제어**
- 상태 머신 패턴: idle → action → wait → idle
- 구간별 온도 조건과 동작 시간
  - 구간 1: 20℃ 이상 → 30초 열림
  - 구간 2,3: 20℃ 이상 → 20초 열림
  - 구간 4: 25℃ 이하 → 20초 닫힘
  - 구간 5: 20℃ 이하 → 20초 닫힘
  - 구간 6,7: 15℃ 이하 → 20초 닫힘
  - 구간 8: 20℃ 이상 → 10초 열림
- 동작 완료 후 5분 대기 → 재측정

**5. 보온커튼 제어**
- 구간 1: 외기온 고려 임계값 (0℃ 이상: 12℃, -10~0℃: 13℃, 그외: 15℃)
- 구간 2-4: 100% 열림 유지
- 구간 5: 15℃ 이하 시 498초 닫힘 동작

**6. 차광스크린 제어**
- 비 감지 시: 즉시 150초 열림 동작
- 구간 3: 일사량 ≥400 → 30% 차광
- 구간 4: 일사량 ≤400 → 30% 열림
- DAT ≥8, 일사량 ≤50 시 동작시간 50% 단축

**7. 관수시스템 제어**
- 토양수분 ≤12.5% 시 작동
- 구간별 관수량: 구간1(50ml), 구간2(30ml), 구간3(20ml), 구간4(15ml)
- 구간1 특별조건: DAT>7 또는 일출+1시간 이후

**8. 유동팬 제어**
- 구간 8에서만 동작
- 온도차 ≥2℃ 감지 시 1분 동작 → 5분 대기
- 최대 3회 사이클 후 완료

### 📊 고급 시뮬레이션 기능
- **8구간 시간대 자동 전환** (일출/일몰 기준)
- **가상 시간 진행** (1~3600배속 지원)
- **실시간 센서 검증** 및 유효하지 않은 값 이전값 대체
- **상태 변경 감지** 시에만 로그 기록
- **DAT 기반 제어** (정식 후 일수)
- **일일 상태 리셋** (관수 완료 등)

### 📝 완전한 로깅 시스템
- 모든 장치 상태 변경 실시간 기록
- 가상 시간 기준 타임스탬프
- 센서 오류 및 범위 초과 로그
- 로그 파일 다운로드 (.txt)
- 최대 1000개 로그 자동 관리

## 파일 구조

```
strawberry_simulator/
├── streamlit_app.py        # Streamlit 메인 애플리케이션
├── control_logic.py        # JavaScript 포팅된 제어 로직
├── business_rules.json     # 모든 제어 기준값 및 설정
├── requirements.txt        # Python 패키지 의존성
└── README.md              # 프로젝트 문서
```

## 설치 및 실행

### 1. 환경 준비
```bash
# Python 3.8 이상 필요
python --version
```

### 2. 패키지 설치
```bash
pip install -r requirements.txt
```

### 3. 애플리케이션 실행
```bash
streamlit run streamlit_app.py
```

### 4. 브라우저 접속
자동으로 열리는 `http://localhost:8501`에서 시뮬레이터 사용

## 사용 방법

### 🚀 시뮬레이션 시작
1. **사이드바 설정**
   - 시작 시간 설정
   - 배속 선택 (실시간 ~ 3600배속)
   - DAT(정식 후 일수) 설정

2. **센서 데이터 입력**
   - 일출/일몰 시간
   - 내부/외부 온도, 습도
   - CO₂, 일사량, 풍속
   - 토양 함수율, 강우 센서

3. **시뮬레이션 제어**
   - ▶️ 시작: 시뮬레이션 개시
   - ⏹️ 중지: 일시 중지
   - 🔄 센서값 즉시 적용: 실시간 반영

### 📈 모니터링
- **실시간 상태 패널**: 8개 장치 동작 상태 시각화
- **제어 로그**: 모든 상태 변경 이력 추적
- **구간/시간 정보**: 현재 구간, 가상시간, DAT 표시

## 제어 로직 상세

### 구간별 시간 분할
- **구간 7**: 일출 3시간 전 ~ 일출 1시간 전 (새벽)
- **구간 8**: 일출 1시간 전 ~ 일출 (해뜨기 직전)
- **구간 1**: 일출 ~ 일출 3시간 후 (오전)
- **구간 2**: 일출 3시간 후 ~ 정오 (오전 후반)
- **구간 3**: 정오 ~ 일몰 3시간 전 (오후)
- **구간 4**: 일몰 3시간 전 ~ 일몰 (오후 후반)
- **구간 5**: 일몰 ~ 일몰 3시간 후 (저녁)
- **구간 6**: 일몰 3시간 후 ~ 일출 3시간 전 (밤)

### 센서 유효성 검증
모든 센서값은 다음 범위에서 검증됩니다:
- **온도**: -20°C ~ 80°C
- **습도**: 0% ~ 100%
- **CO₂**: 0 ~ 2000 ppm
- **일사량**: 0 ~ 1800 W/m²
- **풍속**: 0.5 ~ 89.0 m/s
- **토양수분**: 0 ~ 50 %vol

범위를 벗어난 값은 자동으로 이전 유효값으로 대체됩니다.

## 설정 파일 (business_rules.json)

모든 제어 기준값은 JSON 파일에서 중앙 관리됩니다:

```json
{
  "FOG_CONTROL": {
    "1": {"threshold": 28, "run_time": 60000, "delay_time": 1800000}
  },
  "FCU_CONTROL": {
    "2": {"on_threshold": 30, "off_threshold": 27}
  },
  "WINDOW_CONTROL": {
    "sections": {
      "1": {"temp_threshold": 20, "open_time_sec": 30}
    }
  }
}
```

설정 변경 시 파일 수정 후 앱 재시작으로 즉시 반영됩니다.

## 기술 스택

- **Python 3.8+**
- **Streamlit**: 웹 UI 프레임워크
- **JSON**: 설정 파일 관리  
- **datetime**: 정밀한 시간 계산
- **Object-Oriented Design**: 장치별 클래스 설계

## 성능 및 안정성

- **200ms 업데이트 주기**: 부드러운 실시간 시뮬레이션
- **메모리 효율성**: 최대 1000개 로그 자동 관리
- **상태 보존**: 세션 기반 상태 관리
- **오류 복구**: 센서 오류 시 자동 이전값 사용

## 라이선스

이 프로젝트는 교육 및 연구 목적으로 개발되었습니다.

## 업데이트 이력

### v2.0 (2025.08.29)
- JavaScript controller_2.js 완전 포팅
- 8개 장치 제어 로직 100% 구현
- 상태 머신 패턴 천창 제어 추가
- 센서 검증 및 오류 복구 시스템
- 일일 리셋 및 DAT 관리 기능

### v1.0
- 기본 Streamlit 구조 및 UI 구현

## 지원 및 문의

시뮬레이터 사용 중 문제 발생 시:
1. 센서값 범위 확인
2. 브라우저 콘솔 오류 확인  
3. business_rules.json 파일 존재 확인
4. Python 버전 및 패키지 호환성 확인

---
**🍓 정밀한 스마트팜 시뮬레이션으로 최적의 딸기 재배 환경을 만들어보세요!**